<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Locate the Danger ‚Äî Reports with Details & Urgency</title>
<style>
:root{
  --primary:#ec4899; --bg:#fff1f2; --card:#fff;
  --border:#fbcfe8; --text:#4a044e; --muted:#9d174d;
  --ok:#16a34a; --danger:#ef4444; --warn:#f59e0b;
}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
body{background:var(--bg);color:var(--text);}

#map{position:absolute;inset:0;z-index:0}

/* header + tiny controls */
#header{
  position:absolute;top:8px;left:50%;transform:translateX(-50%);
  background:var(--card);padding:6px 12px;border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);font-weight:700;
  color:var(--primary);font-size:14px;z-index:2200;
}
#clearBtn{position:absolute;top:6px;right:6px;background:#ec4899;color:white;
  border:none;border-radius:50%;width:22px;height:22px;font-size:14px;cursor:pointer;z-index:2200;}
#heatBtn{position:absolute;top:6px;left:6px;background:#4f46e5;color:white;
  border:none;border-radius:8px;padding:6px 8px;font-size:12px;cursor:pointer;z-index:2200;display:flex;align-items:center;gap:8px;}
#heatState{font-size:11px;padding:2px 6px;border-radius:8px;background:#fff;color:#333;border:1px solid var(--border);}

/* search */
#searchBox{
  position:absolute;top:40px;left:50%;transform:translateX(-50%);
  width:60%;max-width:420px;padding:8px;border-radius:10px;border:1px solid var(--border);
  z-index:2100;font-size:14px;background:white;
}
#suggestions{
  position:absolute;top:78px;left:50%;transform:translateX(-50%);
  width:60%;max-width:420px;background:white;border:1px solid var(--border);
  border-radius:8px;z-index:2100;list-style:none;margin:0;padding:0;font-size:14px;display:none;
  max-height:220px;overflow:auto;
}
#suggestions li{padding:8px;cursor:pointer;}
#suggestions li:hover{background:#fbcfe8;}

/* sheet */
#sheet{
  position:absolute;left:0;right:0;bottom:-100%;background:var(--card);
  border-radius:16px 16px 0 0;box-shadow:0 -4px 18px rgba(0,0,0,0.12);
  padding:14px;max-height:72%;overflow:auto;transition:bottom .28s ease;z-index:2000;
}
#sheet.open{bottom:0}
#closeSheet{position:absolute;top:8px;right:12px;background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);}

label{font-size:13px;color:var(--muted);margin-top:8px;display:block}
input[type="text"],select,textarea{
  width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);
  background:transparent;color:var(--text);font-size:14px;
}
textarea{min-height:60px;resize:vertical}
.btn{background:var(--primary);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-size:13px}

/* tasks */
#tasks{margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px}
.task{background:var(--card);border:1px solid var(--border);padding:8px;border-radius:10px;font-size:13px;cursor:pointer}

/* FABs */
#fab-container{
  position:absolute;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:2300;
}
.fab{background:var(--primary);color:#fff;width:54px;height:54px;border:none;border-radius:50%;font-size:22px;
  box-shadow:0 6px 20px rgba(0,0,0,0.18);cursor:pointer;display:flex;align-items:center;justify-content:center}
.fab-label{background:var(--card);color:var(--muted);padding:6px 8px;border-radius:8px;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
#qrCanvas{ pointer-events:none; z-index:1500; position:relative; display:block; margin:6px auto; width:120px; height:120px; }

/* small pulse for high urgency */
@keyframes pulse {
  0% { transform: scale(1); filter: drop-shadow(0 0 4px rgba(255,0,0,0.6)); }
  50% { transform: scale(1.25); filter: drop-shadow(0 0 12px rgba(255,0,0,0.85)); }
  100% { transform: scale(1); filter: drop-shadow(0 0 4px rgba(255,0,0,0.6)); }
}

/* improved urgency slider */
#urgency {
  width:100%;height:6px;margin:8px 0;appearance:none;background:linear-gradient(90deg,var(--ok),var(--warn),var(--danger));
  border-radius:6px;outline:none;
}
#urgency::-webkit-slider-thumb {
  -webkit-appearance:none; appearance:none; width:18px;height:18px;border-radius:50%;background:var(--primary);
  cursor:pointer;border:2px solid white;box-shadow:0 0 6px rgba(0,0,0,0.2);
}
#urgency::-moz-range-thumb {
  width:18px;height:18px;border-radius:50%;background:var(--primary);
  cursor:pointer;border:2px solid white;box-shadow:0 0 6px rgba(0,0,0,0.2);
}
.urg-labels{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;margin-top:2px}
#urgencyValue {font-size:13px;font-weight:600;margin-left:6px}
</style>

<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lz-string/libs/lz-string.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
<div id="map"></div>

<div id="header">‚ö†Ô∏è Locate the Danger</div>
<button id="clearBtn" title="Clear all reports">√ó</button>
<button id="heatBtn" title="Toggle heatmap"><span>Heatmap</span> <span id="heatState">OFF</span></button>

<input id="searchBox" type="text" placeholder="Search address (type & choose)...">
<ul id="suggestions"></ul>

<div id="fab-container">
  <div class="fab-label">New Report</div>
  <button id="reportFab" class="fab" title="New report">üìù</button>

  <div class="fab-label">Local Sync</div>
  <button id="syncFab" class="fab" title="Local sync">üîó</button>

  <div class="fab-label">Find Me</div>
  <button id="locBtn" class="fab" title="Find my location">üìç</button>
</div>

<div id="sheet">
  <button id="closeSheet">‚úñ</button>

  <div id="reportSection" style="display:none">
    <h2>New Report</h2>
    <label>Title</label>
    <input id="title" type="text" placeholder="Short title" />
    <label>Type</label>
    <select id="type">
      <option>Other</option><option>Fire</option><option>Flood</option>
      <option>Power outage</option><option>Medical</option><option>Unsafe person</option>
    </select>
    <label>Details</label>
    <textarea id="details" placeholder="Describe the situation..."></textarea>
    <label>Urgency: <span id="urgencyValue">Med</span></label>
    <input type="range" id="urgency" min="1" max="3" step="1" value="2" />
    <div class="urg-labels"><span>Low</span><span>Med</span><span>High</span></div>
    <button id="addPin" class="btn" style="margin-top:8px">Submit Report (GPS)</button>
    <button id="manualPin" class="btn" style="margin-top:6px;background:#9d174d">Select Location Manually</button>
  </div>

  <div id="syncSection" style="display:none">
    <h2>Local Sync</h2>
    <canvas id="qrCanvas" width="120" height="120"></canvas>
    <div style="display:flex;gap:8px;margin-top:6px">
      <button id="createOffer" class="btn">Host Sync</button>
      <button id="joinOffer" class="btn">Join Sync</button>
    </div>
    <textarea id="sdpArea" placeholder="Paste compressed sync code here" style="width:100%;margin-top:8px;padding:6px;border-radius:8px;border:1px solid var(--border)"></textarea>
    <button id="applySdp" class="btn" style="margin-top:6px">Apply Code</button>
    <button id="backSync" class="btn" style="margin-top:8px;display:none;background:#374151">‚¨Ö Back</button>
    <div style="margin-top:10px;font-size:12px;color:#555">Note: Sync code is compressed for readability ‚Äî copy/paste or scan QR on the other device.</div>
  </div>

  <h2 style="margin-top:12px">Tasks</h2>
  <div id="tasks"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', init);
function init(){
const sheet = document.getElementById('sheet');
const reportSection = document.getElementById('reportSection');
const syncSection = document.getElementById('syncSection');
const closeSheet = document.getElementById('closeSheet');
const reportFab = document.getElementById('reportFab');
const syncFab = document.getElementById('syncFab');
const locBtn = document.getElementById('locBtn');
const addPinBtn = document.getElementById('addPin');
const manualPinBtn = document.getElementById('manualPin');
const clearBtn = document.getElementById('clearBtn');
const heatBtn = document.getElementById('heatBtn');
const heatState = document.getElementById('heatState');
const searchBox = document.getElementById('searchBox');
const suggestions = document.getElementById('suggestions');
const qrCanvas = document.getElementById('qrCanvas');
const createOfferBtn = document.getElementById('createOffer');
const joinOfferBtn = document.getElementById('joinOffer');
const applySdpBtn = document.getElementById('applySdp');
const sdpArea = document.getElementById('sdpArea');
const backSync = document.getElementById('backSync');
const fabContainer = document.getElementById('fab-container');
const urgency = document.getElementById('urgency');
const urgencyValue = document.getElementById('urgencyValue');

const map = new maplibregl.Map({
  container: 'map',
  style: {version:8,sources:{osm:{type:'raster',tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],tileSize:256}},layers:[{id:'osm',type:'raster',source:'osm'}]},
  center:[0,20], zoom:2
});
map.addControl(new maplibregl.NavigationControl());

let reports = [];
let markers = [];
let manualMode = false;
let manualMarker = null;
let heatmapOn = false;
let pc=null, dc=null;
const cfg = { iceServers:[{urls:['stun:stun.l.google.com:19302']}] };

function escapeHtml(text){ if(!text) return ''; return String(text).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

function saveReports(){ try{ localStorage.setItem('locatedanger_reports',JSON.stringify({reports,timestamp:Date.now()})); }catch(e){} }

(function loadReports(){
  try{
    const saved = localStorage.getItem('locatedanger_reports');
    if(!saved) return;
    const parsed = JSON.parse(saved);
    if(Date.now()-(parsed.timestamp||0)<24*60*60*1000) reports = parsed.reports||[];
    else localStorage.removeItem('locatedanger_reports');
  }catch(e){}
  renderTasks();
  renderPins();
})();

function addReport(r){ if(!r.ts) r.ts=Date.now(); reports.push(r); renderTasks(); renderPins(); saveReports(); broadcastReports(); }

function renderTasks(){
  const t = document.getElementById('tasks'); t.innerHTML='';
  reports.forEach((r,idx)=>{
    const div = document.createElement('div'); div.className='task';
    div.innerHTML=`<b>${escapeHtml(r.type)}</b> (${escapeHtml(r.urgencyLabel)})<br>${escapeHtml(r.title)}`;
    let expanded=false;
    div.addEventListener('click',(ev)=>{
      ev.stopPropagation(); expanded=!expanded;
      if(expanded){
        div.innerHTML=`<b>${escapeHtml(r.type)}</b> (${escapeHtml(r.urgencyLabel)})<br>
          <b>${escapeHtml(r.title)}</b><br><i>${escapeHtml(r.details||'')}</i><br>
          <small>Lat: ${Number(r.lat).toFixed(5)}, Lng: ${Number(r.lng).toFixed(5)}</small><br>
          <small>${new Date(r.ts).toLocaleString()}</small>`;
        const pinObj = markers.find(m=>Number(m.ts)===Number(r.ts));
        if(pinObj){
          try{
            map.flyTo({center:[r.lng,r.lat],zoom:14});
            if(pinObj.popup && typeof pinObj.popup.addTo==='function') pinObj.popup.addTo(map);
            else if(pinObj.marker && typeof pinObj.marker.getPopup==='function'){
              const p=pinObj.marker.getPopup(); if(p&&p.addTo)p.addTo(map);
            }
          }catch(e){}
        }
      } else div.innerHTML=`<b>${escapeHtml(r.type)}</b> (${escapeHtml(r.urgencyLabel)})<br>${escapeHtml(r.title)}`;
    });
    t.appendChild(div);
  });
}

function renderPins(){
  markers.forEach(m=>{try{ if(m.marker)m.marker.remove(); }catch(e){} });
  markers=[];
  if(heatmapOn){
    safeRemoveLayer('heat-layer'); safeRemoveSource('reports-source');
    const features = reports.filter(r=>r.lat&&r.lng).map(r=>({type:'Feature',geometry:{type:'Point',coordinates:[Number(r.lng),Number(r.lat)]},properties:{ts:r.ts,urgency:Number(r.urgency||1)}}));
    try{
      map.addSource('reports-source',{type:'geojson',data:{type:'FeatureCollection',features}});
      map.addLayer({id:'heat-layer',type:'heatmap',source:'reports-source',paint:{'heatmap-weight':['interpolate',['linear'],['get','urgency'],1,0.2,3,1],'heatmap-intensity':['interpolate',['linear'],['zoom'],0,1,9,3],'heatmap-radius':['interpolate',['linear'],['zoom'],0,10,9,40],'heatmap-opacity':0.75}});
    }catch(e){}
    return;
  } else { safeRemoveLayer('heat-layer'); safeRemoveSource('reports-source'); }

  reports.forEach(r=>{
    if(!r.lat||!r.lng) return;
    const el=document.createElement('div'); 
    let emoji='üìç';
    if(r.type==='Fire') emoji='üî•'; if(r.type==='Flood') emoji='üåä';
    if(r.type==='Medical') emoji='üöë'; if(r.type==='Power outage') emoji='üí°';
    el.textContent=emoji; el.style.fontSize='20px';
    if(String(r.urgency)==='3'){
      el.style.animation='pulse 1.2s infinite';
      el.style.fontSize='28px';
    }
    const content=`<div style="min-width:180px"><b>${escapeHtml(r.title)}</b><br><small><i>${escapeHtml(r.type)}</i> ‚Äî ${escapeHtml(r.urgencyLabel)}</small><br><div style="margin-top:6px">${escapeHtml(r.details||'')}</div><div style="margin-top:6px;font-size:11px;color:#555">${new Date(r.ts).toLocaleString()}</div></div>`;
    const popup = new maplibregl.Popup({offset:25}).setHTML(content);
    const marker = new maplibregl.Marker({element:el}).setLngLat([Number(r.lng),Number(r.lat)]).setPopup(popup).addTo(map);
    markers.push({marker,popup,ts:r.ts,lat:r.lat,lng:r.lng});
  });
}

function safeRemoveLayer(id){try{if(map.getLayer(id))map.removeLayer(id);}catch(e){}}
function safeRemoveSource(id){try{if(map.getSource(id))map.removeSource(id);}catch(e){}}

// --- BUTTONS ---
closeSheet.addEventListener('click',()=>{sheet.classList.remove('open'); reportSection.style.display='none'; syncSection.style.display='none'; backSync.style.display='none'; fabContainer.style.display='flex';});
reportFab.addEventListener('click',()=>{ reportSection.style.display='block'; syncSection.style.display='none'; sheet.classList.add('open'); backSync.style.display='none'; fabContainer.style.display='none'; });
syncFab.addEventListener('click',()=>{ syncSection.style.display='block'; reportSection.style.display='none'; sheet.classList.add('open'); fabContainer.style.display='none'; });

locBtn.addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    map.flyTo({center:[pos.coords.longitude,pos.coords.latitude],zoom:15});
  });
});

addPinBtn.addEventListener('click',()=>{
  if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const urgencyLevel = urgency.value;                 
    const urgencyLabelText = {1:'Low',2:'Med',3:'High'}[urgencyLevel] || 'Med';
    addReport({
      title: document.getElementById('title').value || 'No title',
      details: document.getElementById('details').value || '',
      type: document.getElementById('type').value,
      urgency: urgencyLevel,
      urgencyLabel: urgencyLabelText,
      lat, lng,
      ts: Date.now()
    });
    sheet.classList.remove('open'); 
    fabContainer.style.display = 'flex';
    confetti({particleCount:30,spread:70});
  });
});

manualPinBtn.addEventListener('click',()=>{
  manualMode = true;
  alert('Click on the map to place your report');
  sheet.classList.remove('open'); 
  fabContainer.style.display = 'flex';
});

map.on('click', e=>{
  if(!manualMode) return;
  manualMode = false;
  if(manualMarker) manualMarker.remove();
  const el = document.createElement('div'); el.textContent='üìç'; el.style.fontSize='22px';
  manualMarker = new maplibregl.Marker(el).setLngLat([e.lngLat.lng,e.lngLat.lat]).addTo(map);
  
  const urgencyLevel = urgency.value;                 
  const urgencyLabelText = {1:'Low',2:'Med',3:'High'}[urgencyLevel] || 'Med';

  addReport({
    title: document.getElementById('title').value || 'No title',
    details: document.getElementById('details').value || '',
    type: document.getElementById('type').value,
    urgency: urgencyLevel,
    urgencyLabel: urgencyLabelText,
    lat: e.lngLat.lat,
    lng: e.lngLat.lng,
    ts: Date.now()
  });
  confetti({particleCount:30,spread:70});
});

clearBtn.addEventListener('click',()=>{
  if(confirm('Clear all reports?')){ reports=[]; saveReports(); renderTasks(); renderPins(); }
});

heatBtn.addEventListener('click',()=>{
  heatmapOn=!heatmapOn; heatState.textContent=heatmapOn?'ON':'OFF'; renderPins();
});

// --- SEARCH ---
let searchTimeout=null;
searchBox.addEventListener('input',e=>{
  const q=e.target.value.trim(); if(!q){ suggestions.style.display='none'; return; }
  if(searchTimeout) clearTimeout(searchTimeout);
  searchTimeout=setTimeout(()=>{
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
      .then(res=>res.json())
      .then(data=>{
        suggestions.innerHTML=''; data.slice(0,6).forEach(d=>{
          const li=document.createElement('li');
          li.textContent=d.display_name;
          li.addEventListener('click',()=>{map.flyTo({center:[d.lon,d.lat],zoom:14}); suggestions.style.display='none'; searchBox.value='';});
          suggestions.appendChild(li);
        });
        suggestions.style.display=data.length>0?'block':'none';
      });
  },300);
});

// --- URGENCY LIVE LABEL ---
function updateUrgencyLabel(){
  const labels={1:'Low',2:'Med',3:'High'};
  urgencyValue.textContent = labels[urgency.value] || 'Med';
  if(urgency.value=="1"){ urgencyValue.style.color = "var(--ok)"; }
  else if(urgency.value=="2"){ urgencyValue.style.color = "var(--warn)"; }
  else { urgencyValue.style.color = "var(--danger)"; }
}
urgency.addEventListener('input', updateUrgencyLabel);
updateUrgencyLabel();

// --- LOCAL SYNC ---
function broadcastReports(){ if(dc&&dc.readyState==='open'){try{dc.send(JSON.stringify({type:'reports',reports}));}catch(e){}}}
function setupConnection(isHost=false, remoteSDP=null){
  pc = new RTCPeerConnection(cfg);
  pc.ondatachannel = e=>{ dc=e.channel; dc.onmessage=handleMsg; }
  if(isHost){ dc = pc.createDataChannel('reports'); dc.onmessage=handleMsg; }
  pc.onicecandidate = e=>{ if(e.candidate) return; if(isHost){ QRCode.toCanvas(qrCanvas, LZString.compressToBase64(JSON.stringify(pc.localDescription))) } else sdpArea.value=LZString.compressToBase64(JSON.stringify(pc.localDescription)); }
  if(isHost) pc.createOffer().then(o=>pc.setLocalDescription(o));
  else if(remoteSDP){ const sd=JSON.parse(LZString.decompressFromBase64(remoteSDP)); pc.setRemoteDescription(sd).then(()=>pc.createAnswer().then(a=>pc.setLocalDescription(a))); }
}
function handleMsg(e){ try{ const data=JSON.parse(e.data); if(data.type==='reports'){ reports=data.reports; renderTasks(); renderPins(); saveReports(); } }catch(e){} }

createOfferBtn.addEventListener('click',()=>{ setupConnection(true); backSync.style.display='inline-block'; });
joinOfferBtn.addEventListener('click',()=>{ const sdp = sdpArea.value.trim(); if(!sdp) return alert('Paste code!'); setupConnection(false,sdp); });
applySdpBtn.addEventListener('click',()=>{ const sdp = sdpArea.value.trim(); if(!sdp) return alert('Paste code!'); setupConnection(false,sdp); });
backSync.addEventListener('click',()=>{ syncSection.style.display='block'; reportSection.style.display='none'; backSync.style.display='none'; qrCanvas.getContext('2d').clearRect(0,0,qrCanvas.width,qrCanvas.height); });

}
</script>
</body>
</html>
